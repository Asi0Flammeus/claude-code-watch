"""Claude Code status line integration."""

import json
import os
import shutil
import stat
from pathlib import Path
from typing import Tuple

from claude_watch.display.colors import Colors

# Claude Code settings file
CLAUDE_SETTINGS_FILE = Path.home() / ".claude" / "settings.json"

# Status line script location
STATUSLINE_SCRIPT = Path.home() / ".claude" / "claude-watch-statusline.sh"

STATUSLINE_SCRIPT_CONTENT = '''#!/bin/bash
# Claude Watch Status Line for Claude Code
# Generated by claude-watch --install-statusline

# Get usage from claude-watch (uses cache for speed)
output=$(claude-watch --prompt minimal 2>/dev/null)
exit_code=$?

# Format based on exit code
case $exit_code in
    0)  # OK (< 75%)
        echo "[$output]"
        ;;
    1)  # Warning (75-90%)
        echo "[âš  $output]"
        ;;
    2)  # Critical (> 90%)
        echo "[ðŸ”´ $output]"
        ;;
    *)  # Error
        echo "[Usage: ?]"
        ;;
esac
'''


def generate_statusline_script() -> str:
    """Generate the status line script content.

    Returns:
        Shell script content.
    """
    return STATUSLINE_SCRIPT_CONTENT


def find_claude_watch_path() -> str:
    """Find the path to claude-watch executable.

    Returns:
        Path to claude-watch or just 'claude-watch' if in PATH.
    """
    # Try to find in PATH
    claude_watch = shutil.which("claude-watch")
    if claude_watch:
        return claude_watch

    # Try common locations
    common_paths = [
        Path.home() / ".local" / "bin" / "claude-watch",
        Path("/usr/local/bin/claude-watch"),
        Path("/usr/bin/claude-watch"),
    ]

    for path in common_paths:
        if path.exists():
            return str(path)

    # Default to just the command name
    return "claude-watch"


def install_statusline(verbose: bool = True) -> Tuple[bool, str]:
    """Install Claude Code status line integration.

    Args:
        verbose: Whether to print progress.

    Returns:
        Tuple of (success, message).
    """
    # Find claude-watch path
    claude_watch_path = find_claude_watch_path()

    # Generate script with correct path
    script_content = STATUSLINE_SCRIPT_CONTENT.replace(
        "claude-watch", claude_watch_path
    )

    # Write the script
    try:
        STATUSLINE_SCRIPT.parent.mkdir(parents=True, exist_ok=True)
        STATUSLINE_SCRIPT.write_text(script_content)
        os.chmod(STATUSLINE_SCRIPT, stat.S_IRWXU | stat.S_IRGRP | stat.S_IXGRP)

        if verbose:
            print(f"{Colors.GREEN}âœ“ Created status line script{Colors.RESET}")
            print(f"  {Colors.DIM}{STATUSLINE_SCRIPT}{Colors.RESET}")
    except OSError as e:
        return False, f"Failed to write script: {e}"

    # Load existing settings
    settings = {}
    if CLAUDE_SETTINGS_FILE.exists():
        try:
            with open(CLAUDE_SETTINGS_FILE) as f:
                settings = json.load(f)
        except (json.JSONDecodeError, OSError):
            pass

    # Update settings
    if "statusLine" not in settings:
        settings["statusLine"] = {}

    settings["statusLine"]["command"] = str(STATUSLINE_SCRIPT)

    # Save settings
    try:
        CLAUDE_SETTINGS_FILE.parent.mkdir(parents=True, exist_ok=True)
        with open(CLAUDE_SETTINGS_FILE, "w") as f:
            json.dump(settings, f, indent=2)
        os.chmod(CLAUDE_SETTINGS_FILE, stat.S_IRUSR | stat.S_IWUSR)

        if verbose:
            print(f"{Colors.GREEN}âœ“ Updated Claude Code settings{Colors.RESET}")
            print(f"  {Colors.DIM}{CLAUDE_SETTINGS_FILE}{Colors.RESET}")
    except OSError as e:
        return False, f"Failed to update settings: {e}"

    if verbose:
        print()
        print(f"{Colors.CYAN}Status line installed successfully!{Colors.RESET}")
        print()
        print("The status bar will show:")
        print(f"  {Colors.GREEN}[S:45% W:23%]{Colors.RESET} - Normal usage")
        print(f"  {Colors.YELLOW}[âš  S:80% W:45%]{Colors.RESET} - Warning (75-90%)")
        print(f"  {Colors.RED}[ðŸ”´ S:95% W:67%]{Colors.RESET} - Critical (>90%)")
        print()
        print(f"{Colors.DIM}Restart Claude Code to see the status line.{Colors.RESET}")

    return True, "Status line installed successfully"
