"""Claude Code hook script generation and installation."""

import json
import os
import sys
from pathlib import Path

from claude_watch.display.colors import Colors

HOOK_SCRIPT_PATH = Path.home() / ".claude" / "hooks" / "claude-watch-hook.sh"
CLAUDE_SETTINGS_PATH = Path.home() / ".claude" / "settings.json"

HOOK_SCRIPT_TEMPLATE = '''#!/bin/bash
# Claude Code Usage Hook - Generated by claude-watch
# This hook checks usage before each prompt and warns if limits are approaching.
#
# Environment variables:
#   CLAUDE_USAGE_THRESHOLD - Threshold percentage to trigger warning (default: 85)
#   CLAUDE_WATCH_SILENT    - Set to "1" to suppress non-blocking output
#
# Exit codes:
#   0 - OK, continue with operation
#   1 - Warning shown (non-blocking)
#   2 - Critical usage (blocking if CLAUDE_WATCH_BLOCKING=1)

set -e

# Configuration
THRESHOLD="${CLAUDE_USAGE_THRESHOLD:-85}"
SILENT="${CLAUDE_WATCH_SILENT:-0}"
BLOCKING="${CLAUDE_WATCH_BLOCKING:-0}"

# Get usage data (use cache for speed)
USAGE_JSON=$(claude-watch --json 2>/dev/null) || exit 0

# Parse session usage
SESSION_USAGE=$(echo "$USAGE_JSON" | grep -o '"utilization": [0-9.]*' | head -1 | grep -o '[0-9.]*')

# Check if we got a valid number
if [ -z "$SESSION_USAGE" ]; then
    exit 0
fi

# Convert to integer for comparison
SESSION_INT=${SESSION_USAGE%.*}

# Check threshold
if [ "$SESSION_INT" -ge 95 ]; then
    if [ "$SILENT" != "1" ]; then
        echo "Warning: Claude usage CRITICAL: ${SESSION_INT}% - Consider pausing"
    fi
    if [ "$BLOCKING" = "1" ]; then
        exit 2
    fi
    exit 1
elif [ "$SESSION_INT" -ge "$THRESHOLD" ]; then
    if [ "$SILENT" != "1" ]; then
        echo "Warning: Claude usage high: ${SESSION_INT}%"
    fi
    exit 1
fi

exit 0
'''


def generate_hook_script() -> str:
    """Generate the hook script content."""
    return HOOK_SCRIPT_TEMPLATE


def write_hook_script() -> Path:
    """Write the hook script to the default location.

    Returns:
        Path to the written hook script.
    """
    HOOK_SCRIPT_PATH.parent.mkdir(parents=True, exist_ok=True)
    with open(HOOK_SCRIPT_PATH, "w") as f:
        f.write(HOOK_SCRIPT_TEMPLATE)
    os.chmod(HOOK_SCRIPT_PATH, 0o755)
    return HOOK_SCRIPT_PATH


def load_claude_settings() -> dict:
    """Load Claude Code settings.json."""
    if not CLAUDE_SETTINGS_PATH.exists():
        return {}
    try:
        with open(CLAUDE_SETTINGS_PATH) as f:
            return json.load(f)
    except (json.JSONDecodeError, IOError):
        return {}


def save_claude_settings(settings: dict) -> None:
    """Save Claude Code settings.json."""
    CLAUDE_SETTINGS_PATH.parent.mkdir(parents=True, exist_ok=True)
    with open(CLAUDE_SETTINGS_PATH, "w") as f:
        json.dump(settings, f, indent=2)


def install_hook() -> bool:
    """Install the hook by writing script and updating settings.json.

    Returns:
        True if installation was successful.
    """
    hook_path = write_hook_script()

    settings = load_claude_settings()

    if "hooks" not in settings:
        settings["hooks"] = {}
    if "PreToolUse" not in settings["hooks"]:
        settings["hooks"]["PreToolUse"] = []

    hook_cmd = str(hook_path)
    existing_hooks = settings["hooks"]["PreToolUse"]

    hook_exists = False
    for hook in existing_hooks:
        if isinstance(hook, str) and hook == hook_cmd:
            hook_exists = True
            break
        elif isinstance(hook, dict) and hook.get("command") == hook_cmd:
            hook_exists = True
            break

    if not hook_exists:
        settings["hooks"]["PreToolUse"].append(hook_cmd)
        save_claude_settings(settings)

    return True


def run_generate_hook(install: bool = False) -> int:
    """Run the hook generation command.

    Args:
        install: Whether to also install the hook.

    Returns:
        Exit code (0 for success).
    """
    if install:
        print(f"{Colors.CYAN}Installing Claude Code usage hook...{Colors.RESET}")
        print()

        try:
            install_hook()
            print(f"{Colors.GREEN}+{Colors.RESET} Hook script written to: {HOOK_SCRIPT_PATH}")
            print(f"{Colors.GREEN}+{Colors.RESET} Settings updated: {CLAUDE_SETTINGS_PATH}")
            print()
            print(f"{Colors.BOLD}Hook installed successfully!{Colors.RESET}")
            print()
            print("Configuration (environment variables):")
            print(
                f"  {Colors.CYAN}CLAUDE_USAGE_THRESHOLD{Colors.RESET}  "
                f"Warning threshold (default: 85)"
            )
            print(
                f"  {Colors.CYAN}CLAUDE_WATCH_SILENT{Colors.RESET}     "
                f"Suppress output (set to 1)"
            )
            print(
                f"  {Colors.CYAN}CLAUDE_WATCH_BLOCKING{Colors.RESET}   "
                f"Block at 95%+ (set to 1)"
            )
            print()
            print("To uninstall, remove the hook from ~/.claude/settings.json")
        except Exception as e:
            print(
                f"{Colors.RED}Error installing hook: {e}{Colors.RESET}",
                file=sys.stderr,
            )
            return 1
    else:
        print(generate_hook_script())

    return 0
